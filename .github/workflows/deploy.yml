name: Deploy to Digital Ocean

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Verify secrets are set
      run: |
        if [ -z "${{ secrets.DO_HOST }}" ]; then
          echo "Error: DO_HOST secret is not set"
          echo "Please add the following secrets to your GitHub repository:"
          echo "- DO_HOST (your Digital Ocean droplet IP or domain)"
          echo "- DO_USERNAME (SSH username, usually 'root')"
          echo "- DO_SSH_KEY (your private SSH key)"
          exit 1
        fi
        echo "âœ… Secrets are configured"
    
    - name: Deploy to Digital Ocean
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        port: 22
        script: |
          echo "ğŸ“¦ Deploying SkateIQ..."
          cd /opt/skateiq || { echo "Directory /opt/skateiq not found"; exit 1; }
          
          echo "ğŸ”„ Pulling latest changes..."
          git pull origin main
          
          echo "ğŸ›‘ Stopping containers..."
          docker-compose down
          
          echo "ğŸ”¨ Building new images..."
          docker-compose build --no-cache
          
          echo "ğŸš€ Starting containers..."
          docker-compose up -d
          
          echo "â³ Waiting for containers to start..."
          sleep 15
          
          echo "ğŸ”„ Running database migrations..."
          docker-compose exec -T app python migrate_live_scores.py || echo "Migration not needed"
          
          echo "âœ… Deployment complete!"
          
    - name: Health Check
      run: |
        echo "ğŸ¥ Running health check..."
        sleep 10
        if curl -f http://${{ secrets.DO_HOST }}:8001/health; then
          echo "âœ… Health check passed"
        else
          echo "âŒ Health check failed"
          exit 1
        fi
