name: Deploy to Digital Ocean

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Verify secrets are set
      run: |
        if [ -z "${{ secrets.DO_HOST }}" ]; then
          echo "Error: DO_HOST secret is not set"
          echo "Please add the following secrets to your GitHub repository:"
          echo "- DO_HOST (your Digital Ocean droplet IP or domain)"
          echo "- DO_USERNAME (SSH username, usually 'root')"
          echo "- DO_SSH_KEY (your private SSH key)"
          exit 1
        fi
        echo "‚úÖ Secrets are configured"
    
    - name: Test SSH connectivity
      run: |
        echo "üîç Testing connection to ${{ secrets.DO_HOST }}..."
        echo "Testing port 22..."
        timeout 10 bash -c "cat < /dev/null > /dev/tcp/${{ secrets.DO_HOST }}/22" && echo "‚úÖ Port 22 is open" || echo "‚ùå Port 22 is closed or unreachable"
    
    - name: Trigger deployment via webhook
      run: |
        echo "üì° Triggering deployment webhook..."
        curl -X POST -H "Authorization: Bearer ${{ secrets.WEBHOOK_TOKEN }}" \
          http://${{ secrets.DO_HOST }}:9000/hooks/deploy-skateiq \
          || echo "Webhook not available, trying SSH..."
    
    - name: Deploy via SSH (fallback)
      if: failure()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 30m
        script: |
          echo "üì¶ Deploying SkateIQ via SSH..."
          cd /opt/skateiq || { echo "Directory /opt/skateiq not found"; exit 1; }
          
          echo "üîÑ Pulling latest changes..."
          git pull origin main
          
          echo "üõë Stopping containers..."
          docker-compose down
          
          echo "üî® Building new images..."
          docker-compose build --no-cache
          
          echo "üöÄ Starting containers..."
          docker-compose up -d
          
          echo "‚è≥ Waiting for containers to start..."
          sleep 15
          
          echo "üîÑ Running database migrations..."
          docker-compose exec -T app python migrate_live_scores.py || echo "Migration not needed"
          
          echo "‚úÖ Deployment complete!"
          
    - name: Health Check
      run: |
        echo "üè• Running health check..."
        sleep 10
        if curl -f http://${{ secrets.DO_HOST }}:8001/health 2>/dev/null; then
          echo "‚úÖ Health check passed"
        else
          echo "‚ö†Ô∏è Health check not available yet"
        fi
